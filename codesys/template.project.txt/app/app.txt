// SPDX-FileCopyrightText: 2025 Artur Wiebe <artur@4wiebe.de>
// SPDX-License-Identifier: MIT

PROGRAM app

VAR_OUTPUT
	cfg: AppCfg;
	cmd: AppCmd;
END_VAR
VAR_INPUT
	fbk: AppFbk;
END_VAR

VAR CONSTANT
	CFG_FILE: STRING := '/run/codesys/cfg';
END_VAR
VAR
	shm: RTS_IEC_HANDLE;
	sem: RTS_IEC_HANDLE;
	iec_result: RTS_IEC_RESULT;
	sync: BYTE := 0;
	missed: UDINT := 0;
END_VAR

////////////////////////////////

SysSharedMemoryRead (shm, 0, ADR(sync), SIZEOF(sync), ADR(iec_result));
IF sync > 0 THEN
	SysSharedMemoryRead (shm, SIZEOF(sync), ADR(cmd), SIZEOF(cmd), ADR(iec_result));
ELSE
	missed := missed + 1;
END_IF


IF init.done THEN
	main();
ELSE
	init();
END_IF


IF sync > 0 THEN
	sync := 0;
	SysSharedMemoryWrite(shm, SIZEOF(sync) + SIZEOF(cmd), ADR(fbk), SIZEOF(fbk), ADR(iec_result));
	SysSharedMemoryWrite(shm, 0, ADR(sync), SIZEOF(sync), ADR(iec_result));
	SysSemProcessLeave(sem);
END_IF
