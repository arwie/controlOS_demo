#!/usr/bin/python -Bu

# SPDX-FileCopyrightText: 2025 Artur Wiebe <artur@4wiebe.de>
# SPDX-License-Identifier: MIT

from typing import Any
import argparse, json, tempfile, os, subprocess
from pathlib import Path
from socket import gethostbyname
from shared import log, system
from shared.conf import Conf


parser = argparse.ArgumentParser()
parser.add_argument("name", nargs='?', help="name of the esp32 project")
parser.add_argument("--ip", help="ip address")
args = parser.parse_args()

term = 'TERM' in os.environ


log.info(f'update esp32 project: {args.name}')
os.chdir(f'/usr/lib/esp32/{args.name}')

flashconf = Conf('flash.conf')

cfg:dict[str, Any] = {
	'ota': f"http://{gethostbyname('sys')}:8102/{args.name}"
}
if flashconf.getboolean('net', 'wifi', fallback=True):
	cfg['wifi'] = {
		'bssid':	[int(h,16) for h in Path('/sys/class/net/syswlan/address').read_text().strip().split(':')],
		'psk':		Path('/etc/hostapd/hostapd.wpa_psk').read_text().strip().split()[1]
	}
if args.ip:
	cfg['net'] = {
		'ip':	gethostbyname(args.ip),
	}

with tempfile.NamedTemporaryFile() as cfgFile:
	cfgFile.write(json.dumps(cfg).encode() + b'\0')
	cfgFile.flush()
	
	flash = {
		'boot': ('0x1000',  'boot.bin'),
		'part': ('0x8000',  'part.bin'),
		'cfg':  ('0x89000',  cfgFile.name),
		'ota':  ('0x8d000', 'ota.bin'),
		'app':  ('0x90000', 'app.bin'),
	}
	system.run(
		['esptool.py', 'write_flash', *flash['boot'], *flash['part'], *flash['cfg'], *flash['ota'], *flash['app']],
		stdout=(None if term else subprocess.PIPE)
	)

log.info('esp32 updated successfully')
