<?com_websocket(55003)?>

dim shared this_travHeight		as const double	= 71
dim shared this_pickHeight		as const double	= 105.5
dim shared this_scanPos			as const location of xyzr = #{120, 0, this_travHeight, 0}

dim shared this_placePos		as location of xyzr = #{116, 78, 73, 0}
dim shared this_objectCount		as long



<?output('outShake', 'long', 'delta1a')?>
	system.dout[10000+delta1a_deviceAddress*100+1][1] = not value_
end sub

<?output('outLight', 'long', 'delta1b')?>
	system.dout[10000+delta1b_deviceAddress*100+1][1] = not value_
end sub



<?lib_init()?>
	shaker_outShake(false)
	shaker_outLight(false)
end sub


<?lib_prgStart()?>
	this_objectCount = 0
	delta1_enableAttach()
	tool_select(tool_typeMagnet)
	moves #{0, 0, this_travHeight, 0} vrate=30
end sub


<?com_prgReceive('this_websocket', 1500)?>
	shaker_outLight(false)
	select case receive_
	case com_receiveNotify
		shakeAndScan()
	case com_receiveMessage
		fetchObject()
	case com_receiveDisconnect
		moves #{0, 0, this_travHeight, 0} vrate=30
		waitForMotion
		shaker_stopTrigger()
	end select
end sub


<?lib_prgStop()?>
	tool_select(tool_typeNone)
	delta1_disableDetach()
end sub


<?lib_prgError()?>
	stop stoptype=ABORT
	if not prgRunning then
		shaker_prgStop()
		shaker_stopTrigger()
	end if
end sub


<?lib_stopTrigger()?>
	stop stoptype=ABORT
end sub


sub shakeAndScan
	moves this_scanPos vrate=50
	shaker_outShake(true)
	sleepActive(300)
	shaker_outShake(false)
	shaker_outLight(true)
	sleepActive(600)
	waitForMotion
	com_clear()
	com_send(this_websocket)
end sub

sub fetchObject
	dim pickPos_  as location of xyzr = com_getLocationXyzr("/pos")
	dim placePos_ as location of xyzr = this_placePos + #{-26*int(this_objectCount / 7), -26*(this_objectCount mod 7), 0,0}
	increment(this_objectCount)
	moves posWithHeight(pickPos_, this_travHeight)
	moves posWithHeight(pickPos_, this_pickHeight) drate=30
	tool_grip(true)
	waitForMotion
	sleepActive(50)
	moves posWithHeight(pickPos_, this_travHeight) arate=50
	moves posWithHeight(placePos_, this_travHeight)
	moves placePos_
	waitForMotion
	tool_grip(false)
	sleepActive(10)
	moves posWithHeight(placePos_, this_travHeight)
end sub


function posWithHeight(byval pos_ as location of xyzr, byval height_ as double) as location of xyzr
	pos_{3} = height_
	posWithHeight = pos_
end function
