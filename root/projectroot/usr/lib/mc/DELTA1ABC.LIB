<?axis([
	'device'		=> 'stepim',
	'bus'			=> 'can',
])?>



<?drive_update(3)?>
	dim posFactor_ as double = 4096 / 70
	
	<?=lib()?>_deviceWrite(0x607C, 0, 32, -2.5*posFactor_)	'Home Offset
	<?=lib()?>_deviceWrite(0x2F22, 0, 16, 1000)				'Home On Edge Current Saturation [mA]
end sub


<?drive_setup()?>
	positionfactor				= positionfactor / 70
	direction					= 1
	
	<?=lib()?>_deviceWrite(0x6098, 0,  8, -1)				'Homing Method (-1 = homing on hard stop in negative direction)
end sub


<?axis_setup()?>
	absolute					= true
	absEnable					= false		'disable abs motions until homed
	
	positionmin					= 0
	positionmax					= 145
	positionminenable			= true
	positionmaxenable			= true
	
	axistype					= 0
	
	<?axis_setupSpeed(200, 150, 50)?>
	
	positionerrormax			= 5
end sub



<?output('opMode', 'long', lib())?>
	<?=lib()?>_deviceWrite(0x6060, 0, 8, value_)
end sub


public function <?=lib()?>_homingLoop as long
	if not absEnable then
		if not enable then
			attach
			followingMode = 2
			<?=lib()?>_opMode(6)
			enable = true
		else
			if getBit(driveStatus, 10) then
				enable = false
				<?=lib()?>_opMode(8)
				if getBit(driveStatus, 12) then
					absEnable = true
					detach
				else
					<?logThrow([lib().": homing error"])?>
				end if
			end if
		end if
	end if
	<?=lib()?>_homingLoop = absEnable
end function



<?lib_debug()?>
	com_putBool("absEnable",			absEnable)
	com_putLong("followingMode",		followingMode)
end sub
