<?axis([
	'device'		=> 'stepim',
	'bus'			=> 'can',
])?>



<?drive_update(12)?>
	<?=lib()?>_deviceWrite(0x607C, 0, 32, 0)					'Home Offset
	<?=lib()?>_deviceWrite(0x2F22, 0, 16, 1000)					'Home On Edge Current Saturation [mA]
	
	<?=lib()?>_driveTune(18000, 0, 0, 350, 8000, 200)
end sub


<?drive_setup()?>
	positionfactor				= positionfactor / 70
	direction					= 1
	
	<?=lib()?>_deviceWrite(0x6098, 0,  8, -3)				'Homing Method (-3 = homing on hard stop in negative direction with index)
end sub


<?axis_setup()?>
	absolute					= true
	absEnable					= false		'disable abs motions until homed
	
	positionmin					= 242
	positionmax					= positionmin + 146
	positionminenable			= true
	positionmaxenable			= true
	
	axistype					= 0
	
	<?axis_setupSpeed(300, 150, 50)?>
	
	positionerrormax			= 2
end sub





public function <?=lib()?>_homingLoop as long
	if not absEnable then
		if not enable then
			attach
			followingMode = 2
			<?=lib()?>_deviceWrite(0x6060, 0, 8, 6)
			<?=lib()?>_enable()
		else
			if getBit(driveStatus, 10) then
				absEnable = getBit(driveStatus, 12)
				<?=lib()?>_disableDetach()
				<?=lib()?>_deviceWrite(0x6060, 0, 8, 8)
			end if
		end if
	end if
	<?=lib()?>_homingLoop = absEnable
end function



<?lib_debug()?>
	com_putBool("absEnable",			absEnable)
	com_putLong("followingMode",		followingMode)
end sub
