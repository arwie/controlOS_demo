{% comment 
# Copyright (c) 2017 Artur Wiebe <artur@4wiebe.de>
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
# associated documentation files (the "Software"), to deal in the Software without restriction,
# including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%}

{% extends "page.html" %}


{% block html %}
<div class="row">
	
	<script type="text/html" id="simio-io">
		<table class="table table-sm table-hover">
		<thead>
			<tr>
				<th data-l10n-id="name"></th>
				<th data-l10n-id="type"></th>
				<th data-l10n-id="app"></th>
				<th data-l10n-id="io"></th>
				<th data-l10n-id="override"></th>
			</tr>
		</thead>
		<tbody data-bind="foreach: $data">
			<tr>
				<th><p data-bind="text:name" class="form-control-plaintext"></p></th>
				<td><p data-bind="text:dir+'&nbsp;/&nbsp;'+type" class="form-control-plaintext"></p></td>
				<td  style="width:30%">
					<p data-bind="text:app" class="form-control-plaintext"></p>
				</td>
				<td  style="width:30%">
					<!-- ko if:!sim--><p data-bind="text:io" class="form-control-plaintext"></p><!-- /ko -->
					<!-- ko if: sim--><p class="form-control-plaintext"><i class="fa fa-ban"></i></p><!-- /ko -->
				</td>
				<td style="min-width:200px">
					<div class="input-group">
						<div class="input-group-prepend"><span class="input-group-text">
							<input data-bind="checked:ord, disable:sim, click:ordToggle" type="checkbox">
						</span></div>
						<input data-bind="event:{keypress:ordSendValue}" type="text" class="form-control">
						<!-- ko if:type=='long'-->
						<div class="input-group-append">
							<button data-bind="click:ordSendPreset" class="btn btn-outline-secondary" type="button" value="1">1</button>
							<button data-bind="click:ordSendPreset" class="btn btn-outline-primary"   type="button" value="0">0</button>
						</div>
						<!-- /ko -->
					</div>
				</td>
			</tr>
		</tbody>
		</table>
	</script>
	
	<div data-bind="template: { name:'simio-io', data:inputs }"  class="col"></div>
	<div data-bind="template: { name:'simio-io', data:outputs }" class="col"></div>
	
</div>
{% end %}


{% block script %}
function Io(io) {
	let self = this;
	
	self.id		= io.id;
	self.sim	= io.sim;
	self.name	= io.name;
	self.dir	= io.dir;
	self.type	= io.type;
	
	self.ord	= ko.observable();
	self.app	= ko.observable();
	self.io		= ko.observable();
	
	self.ordToggle = function() {
		model.send({id:self.id, ord:(self.ord()?1:0)});
	}
	
	self.ordSendValue = function(d, e) {
		if (e.keyCode != 13) return true;
		model.send({id:self.id, ord:2, io:self.parseType(e.target.value)});
		e.target.value = '';
	}
	
	self.ordSendPreset = function(d, e) {
		model.send({id:self.id, ord:2, io:self.parseType(e.target.value)});
	}
	
	self.update	= function(io) {
		self.app(io.app);
		self.io(io.io);
		self.ord(io.ord);
	}
	
	self.parseType = function(value) {
		switch (self.type) {
			case 'long':
				return parseInt(value);
			case 'double':
				return parseFloat(value);
		}
		return value;
	}
}
{% end %}


{% block model %}
class {
	constructor() {
		this.ios		= {};
		this.inputs		= ko.observableArray();
		this.outputs	= ko.observableArray();
	}
	
	send(msg) {
		this.mc.send(JSON.stringify(msg));
	}
	
	start()
	{
		this.mc = new WebSocket(wsUrl('mc', 6002));
		
		this.mc.onmessage = (e) => {
			let msg = JSON.parse(e.data);
			
			if ($.isEmptyObject(this.ios)) {
				for (let io of msg) {
					this.ios[io.id] = new Io(io);
					if (io.dir == 'in')
						this.inputs.push(this.ios[io.id]);
					else
						this.outputs.push(this.ios[io.id]);
				}
			} else {
				for (let io of msg) {
					this.ios[io.id].update(io);
				}
			}
		}
	}
	
	stop() {
		this.mc.close();
	}
}
{% end %}


{% block guard %}
	return gui.isState('mc@simio');
{% end %}
